name: GitGuardian Secret Scan

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly full scan on Mondays at 2 AM
  workflow_dispatch:  # Allow manual trigger

jobs:
  gitguardian-scan:
    name: GitGuardian Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive scanning
    
    - name: GitGuardian Scan
      uses: GitGuardian/ggshield-action@v1
      env:
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        GITHUB_PULL_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      with:
        args: --all-policies --verbose
      continue-on-error: false  # Fail the build if secrets are found
    
    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gitguardian-scan-results
        path: |
          ggshield-output.json
          ggshield-output.txt
        retention-days: 30
      continue-on-error: true

  gitleaks-scan:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks Pro
      continue-on-error: true

  trufflehog-scan:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true

  secret-scan-summary:
    name: Secret Scan Summary
    runs-on: ubuntu-latest
    needs: [gitguardian-scan, gitleaks-scan, trufflehog-scan]
    if: always()
    
    steps:
    - name: Check scan results
      run: |
        echo "Secret Scanning Summary:"
        echo "========================"
        echo "GitGuardian: ${{ needs.gitguardian-scan.result }}"
        echo "Gitleaks: ${{ needs.gitleaks-scan.result }}"
        echo "TruffleHog: ${{ needs.trufflehog-scan.result }}"
        echo ""
        if [ "${{ needs.gitguardian-scan.result }}" == "failure" ]; then
          echo "❌ GitGuardian detected secrets!"
          exit 1
        fi
        echo "✅ No critical secrets detected"
